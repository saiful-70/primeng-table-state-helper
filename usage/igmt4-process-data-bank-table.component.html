<div class="my-3 w-full rounded-md bg-white p-3">
  <p-toolbar styleClass="mb-2">
    <ng-template #start>
      <h2 class="font-semibold md:text-lg">
        {{ componentState.componentTitle() }}
      </h2>
    </ng-template>

    <ng-template #end>
      <div class="flex gap-2">
        <p-button
          (onClick)="openCreateDialog()"
          [disabled]="!hasCreatePermission()"
          icon="pi pi-plus"
          raised
          size="small" />
        <p-button
          icon="pi pi-refresh"
          raised
          size="small"
          (onClick)="tableState.clearTableData(dt)"
          [disabled]="!hasReadPermission()" />
      </div>
    </ng-template>
  </p-toolbar>
  <div class="pt-1">
    <p-table
      #dt
      [value]="tableState.data()"
      stripedRows
      showGridlines
      selectionMode="single"
      [selection]="componentData.singleData()"
      (selectionChange)="componentData.singleData.set($event)"
      [metaKeySelection]="false"
      [loading]="tableState.isLoading()"
      [resetPageOnSort]="false"
      [lazy]="true"
      [rowHover]="true"
      [resizableColumns]="true"
      [dataKey]="tableState.uniqueKey()"
      [scrollable]="true"
      scrollHeight="70vh"
      [paginator]="true"
      [pageLinks]="5"
      [customSort]="true"
      (onLazyLoad)="tableState.onLazyLoad($event)"
      [totalRecords]="tableState.totalRecords()"
      [rows]="15"
      [rowsPerPageOptions]="[15, 25, 50]"
      [tableStyle]="{ 'min-width': '50rem' }"
      size="small">
      <ng-template #header>
        <tr>
          <th style="width: 4rem">Option</th>
          @for (header of tableHeaders(); track header.identifier.field) {
            <th
              [class]="header.identifier.styleClass"
              [pSortableColumn]="
                header.identifier.hasSort ? header.identifier.field : undefined
              ">
              {{ header.identifier.label }}
              @if (header.filter) {
                <p-columnFilter
                  display="menu"
                  [showMatchModes]="true"
                  [showOperator]="false"
                  [showAddButton]="false"
                  [showMenu]="true"
                  [showClearButton]="true"
                  [type]="header.filter.type"
                  [field]="header.identifier.field"
                  [placeholder]="header.filter.placeholder"
                  [matchMode]="header.filter.defaultMatchMode"
                  [matchModeOptions]="header.filter.matchModeOptions"
                  [ariaLabel]="header.filter.ariaLabel" />
              }
              @if (header.identifier.hasSort) {
                <p-sortIcon field="{{ header.identifier.field }}" />
              }
            </th>
          }
        </tr>
      </ng-template>

      <ng-template #body let-entity>
        <tr
          [pSelectableRow]="entity"
          [pSelectableRowDisabled]="!componentState.isSelectableRowEnabled()">
          <td>
            <div class="flex items-center gap-2">
              <p-button
                fluid
                raised
                rounded
                icon="pi pi-bars"
                size="small"
                (onClick)="op.toggle($event)" />
            </div>

            <p-popover (onShow)="onPopOverMenuOpen(entity)" #op>
              <div class="flex flex-col gap-2">
                <p-button
                  raised
                  [disabled]="!hasUpdatePermission()"
                  label="Edit/Preview"
                  class="w-32"
                  size="small"
                  (onClick)="openUpdateDialog()"
                  fluid />

                <p-button
                  raised
                  [disabled]="!entity.isDataLocked || !hasRevisePermission()"
                  label="Revise/Versioning"
                  class="w-32"
                  size="small"
                  (onClick)="openReviseDialog()"
                  fluid />

                <p-button
                  raised
                  [disabled]="!entity.lastChangeNo || !hasReadPermission()"
                  label="Revise Log"
                  class="w-32"
                  size="small"
                  (onClick)="openReviseLogDialog()"
                  fluid />
              </div>
            </p-popover>
          </td>

          @for (header of tableHeaders(); track header.identifier.field) {
            @if (header.identifier.isBoolean) {
              <td>
                @if (entity[header.identifier.field]) {
                  <p-tag value="Yes" severity="success" />
                } @else {
                  <p-tag value="No" severity="danger" />
                }
              </td>
            } @else if (header.identifier.field.endsWith("Utc")) {
              <td>
                {{ entity[header.identifier.field] | date: "medium" : "+6000" }}
              </td>
            } @else if (header.identifier.field.endsWith("Date")) {
              <td>
                {{ entity[header.identifier.field] | date: "mediumDate" }}
              </td>
            } @else if (
              header.identifier.field === "description" ||
              header.identifier.field === "conditionDescription"
            ) {
              <td class="min-w-52 !whitespace-normal break-words">
                {{ entity[header.identifier.field] }}
              </td>
            } @else {
              <td>
                {{ entity[header.identifier.field] }}
              </td>
            }
          }
        </tr>
      </ng-template>

      <ng-template #emptymessage>
        <tr class="h-52 text-center">
          <td
            class="w-full !text-center !text-lg !font-semibold"
            colspan="100%">
            @if (!hasReadPermission()) {
              You don't have permission to view any data.
            } @else {
              No data found
            }
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>
